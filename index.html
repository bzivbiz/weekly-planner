<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Weekly Task Planner - Plan and track your tasks">
  <meta name="theme-color" content="#2563eb">
  <title>Weekly Task Planner</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Task Planner">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React and ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #374151;
    }
    
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    .sticky-col {
      position: sticky;
      left: 0;
      z-index: 2;
    }
    
    .sticky-col-header {
      position: sticky;
      left: 0;
      z-index: 20;
      background-color: #374151;
    }
    
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #374151 !important;
    }
    
    .sticky-corner {
      position: sticky;
      left: 0;
      top: 0;
      z-index: 30;
      background-color: #374151 !important;
    }
    
    thead th {
      background-color: #374151 !important;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDj1OlKvkM1CeGcVJwr8CGCGhqQxK8ovVY",
      authDomain: "weekly-planner-545f2.firebaseapp.com",
      databaseURL: "https://weekly-planner-545f2-default-rtdb.firebaseio.com",
      projectId: "weekly-planner-545f2",
      storageBucket: "weekly-planner-545f2.firebasestorage.app",
      messagingSenderId: "837034017381",
      appId: "1:837034017381:web:1e995d885dd341501bfc8c"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // Firebase Storage API wrapper
    window.storage = {
      async get(key, shared) {
        try {
          const snapshot = await database.ref(key).once('value');
          const value = snapshot.val();
          return value ? { key, value: JSON.stringify(value), shared: false } : null;
        } catch (error) {
          console.error('Firebase get error:', error);
          return null;
        }
      },
      async set(key, value, shared) {
        try {
          const data = JSON.parse(value);
          await database.ref(key).set(data);
          return { key, value, shared: false };
        } catch (error) {
          console.error('Firebase set error:', error);
          return null;
        }
      },
      async delete(key, shared) {
        try {
          await database.ref(key).remove();
          return { key, deleted: true, shared: false };
        } catch (error) {
          console.error('Firebase delete error:', error);
          return null;
        }
      },
      async list(prefix, shared) {
        try {
          const snapshot = await database.ref().once('value');
          const data = snapshot.val() || {};
          const keys = Object.keys(data).filter(k => !prefix || k.startsWith(prefix));
          return { keys, prefix, shared: false };
        } catch (error) {
          console.error('Firebase list error:', error);
          return { keys: [], prefix, shared: false };
        }
      },
      onValue(key, callback) {
        database.ref(key).on('value', (snapshot) => {
          callback(snapshot.val());
        });
      },
      off(key) {
        database.ref(key).off();
      }
    };
  </script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const DEFAULT_CATEGORIES = [
      { name: 'at desk', color: 'bg-blue-100 border-blue-300 text-blue-900' },
      { name: 'investments', color: 'bg-green-100 border-green-300 text-green-900' },
      { name: 'exercise', color: 'bg-purple-100 border-purple-300 text-purple-900' },
      { name: 'planning', color: 'bg-pink-100 border-pink-300 text-pink-900' },
      { name: 'writing', color: 'bg-yellow-100 border-yellow-300 text-yellow-900' },
      { name: 'home', color: 'bg-indigo-100 border-indigo-300 text-indigo-900' },
      { name: 'reading', color: 'bg-orange-100 border-orange-300 text-orange-900' },
      { name: 'other', color: 'bg-gray-100 border-gray-300 text-gray-900' }
    ];

    const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const IMPORTANCE_LEVELS = ['A', 'B', 'C', 'D'];

    const INITIAL_TASKS = [
      {name:"WSJ",category:"reading",importance:"C",minutes:45,id:1771275285174},
      {name:"Calesthenics",category:"exercise",importance:"C",minutes:30,id:1771275540463},
      {name:"email",category:"at desk",importance:"C",minutes:30,id:1771275568207},
      {name:"Investment reading",category:"investments",importance:"B",minutes:45,id:1771275642092},
      {name:"Lay out week",category:"planning",importance:"A",minutes:30,id:1771275690070},
      {name:"Laundry",category:"home",importance:"D",minutes:60,id:1771275728369},
      {name:"Investing course",category:"writing",importance:"A",minutes:60,id:1771275938018},
      {name:"Walk/ruck",category:"exercise",importance:"C",minutes:60,id:1771276285784},
      {name:"Desk clean/tidy",category:"at desk",importance:"C",minutes:15,id:1771276308110},
      {name:"book/Kindle",category:"reading",importance:"B",minutes:30,id:1771276332182},
      {name:"Podcasts",category:"reading",importance:"B",minutes:30,id:1771276352222},
      {name:"Economist",category:"reading",importance:"C",minutes:30,id:1771276371134},
      {name:"Raindrop",category:"reading",importance:"C",minutes:30,id:1771276381950},
      {name:"Audible",category:"reading",importance:"C",minutes:45,id:1771276401238},
      {name:"Quicken/bank/financial",category:"at desk",importance:"B",minutes:15,id:1771276429439},
      {name:"Priorities by epoch",category:"planning",importance:"A",minutes:45,id:1771276451006},
      {name:"travel",category:"other",importance:"B",minutes:240,id:1771276487253},
      {name:"Ski/hike",category:"exercise",importance:"C",minutes:360,id:1771276503213},
      {name:"Allocation sheets",category:"investments",importance:"C",minutes:60,id:1771276523022},
      {name:"Vibe coding",category:"other",importance:"B",minutes:60,id:1771276536877},
      {name:"Bike/spin/run/stairs",category:"exercise",importance:"C",minutes:60,id:1771276567095},
      {name:"Investment action",category:"investments",importance:"A",minutes:30,id:1771276577590},
      {name:"Reading notes",category:"writing",importance:"B",minutes:45,id:1771276602319},
      {name:"Lulu-Lincoln",category:"other",importance:"D",minutes:45,id:1771276623094},
      {name:"Sell stuff (Craigslist)",category:"home",importance:"C",minutes:30,id:1771276648270},
      {name:"Pump bike tires",category:"home",importance:"D",minutes:30,id:1771276667356},
      {name:"Forester due 87k 7/11/26",category:"other",importance:"C",minutes:60,id:1771276719014},
      {name:"Xtrek due 24.5k 8/9/26",category:"other",importance:"C",minutes:60,id:1771276754247},
      {name:"Summer activity",category:"planning",importance:"C",minutes:45,id:1771276783359},
      {name:"Backpack plan",category:"planning",importance:"C",minutes:30,id:1771276805486},
      {name:"Laundry",category:"home",importance:"C",minutes:60,id:1771277285638}
    ];

    const INITIAL_WEEKLY_DATA = {"2026-02-16":{"1":{"urgencies":{"0":2},"completed":{}},"2":{"urgencies":{"0":1},"completed":{}},"3":{"urgencies":{"0":2},"completed":{"0":true}}},"2026-02-15":{"1771275285174":{"urgencies":{"2":1,"3":1,"4":1,"5":1,"6":1},"completed":{}},"1771275540463":{"urgencies":{"0":3,"1":2,"3":2,"4":2,"5":2},"completed":{}},"1771275568207":{"urgencies":{"0":4,"1":2,"2":2,"3":2,"4":2,"5":2,"6":4},"completed":{}},"1771275938018":{"urgencies":{"1":2,"3":2,"5":2},"completed":{}},"1771276285784":{"urgencies":{"1":2,"3":2,"5":2},"completed":{}},"1771276308110":{"urgencies":{"0":2,"1":3,"2":3,"3":3,"4":3,"5":3},"completed":{}},"1771276332182":{"urgencies":{"0":3,"1":3,"2":3,"3":3,"4":3,"5":3,"6":3},"completed":{}},"1771276352222":{"urgencies":{"1":3,"3":3,"5":3},"completed":{}},"1771276371134":{"urgencies":{"0":3,"1":3,"3":3,"4":3,"5":3},"completed":{"0":true}},"1771276381950":{"urgencies":{"0":3,"1":3,"2":3,"3":3,"4":3,"5":3,"6":3},"completed":{"0":true}},"1771276401238":{"urgencies":{"0":4,"1":4,"2":4,"3":4,"4":4,"5":4,"6":4},"completed":{"0":true}},"1771276429439":{"urgencies":{"0":4,"2":4,"3":4,"4":4},"completed":{"0":true}},"1771276451006":{"urgencies":{"4":1},"completed":{}},"1771276487253":{"urgencies":{"6":2},"completed":{}},"1771276503213":{"urgencies":{"2":1},"completed":{}},"1771276523022":{"urgencies":{"0":3,"3":2},"completed":{"0":true}},"1771276536877":{"urgencies":{"1":3,"4":3},"completed":{"1":true}},"1771276567095":{"urgencies":{"0":3,"4":3},"completed":{"0":true}},"1771277285638":{"urgencies":{"5":4},"completed":{}},"1771275642092":{"urgencies":{"0":3,"1":3,"3":3,"5":3},"completed":{"0":true}},"1771275690070":{"urgencies":{"0":1},"completed":{"0":true}}}};

    function WeeklyPlanner() {
      const [tasks, setTasks] = useState([]);
      const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
      const [weeklyData, setWeeklyData] = useState({});
      const [currentWeekStart, setCurrentWeekStart] = useState(getSunday(new Date()));
      const [loading, setLoading] = useState(true);
      const [showTaskManager, setShowTaskManager] = useState(false);
      const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });
      const [isMobile, setIsMobile] = useState(false);
      const [selectedDay, setSelectedDay] = useState(0);
      const [syncStatus, setSyncStatus] = useState('Syncing...');

      useEffect(() => {
        // Initial load
        loadData();
        
        // Poll Firebase every 30 seconds for updates from other devices
        const pollInterval = setInterval(async () => {
          try {
            const tasksSnapshot = await database.ref('planner-tasks').once('value');
            const weeklySnapshot = await database.ref('planner-weekly').once('value');
            const categoriesSnapshot = await database.ref('planner-categories').once('value');
            
            const tasksData = tasksSnapshot.val();
            const weeklyDataFromDB = weeklySnapshot.val();
            const categoriesData = categoriesSnapshot.val();
            
            if (tasksData && Array.isArray(tasksData) && tasksData.length > 0) {
              setTasks(tasksData);
            }
            
            if (weeklyDataFromDB && typeof weeklyDataFromDB === 'object') {
              setWeeklyData(weeklyDataFromDB);
            }
            
            if (categoriesData && Array.isArray(categoriesData) && categoriesData.length > 0) {
              setCategories(categoriesData);
            }
            
            setSyncStatus('Synced ‚úì');
          } catch (error) {
            console.error('Poll error:', error);
            setSyncStatus('Sync error');
          }
        }, 30000); // Poll every 30 seconds
        
        const checkMobile = () => {
          setIsMobile(window.innerWidth < 768);
        };
        checkMobile();
        window.addEventListener('resize', checkMobile);
        
        return () => {
          clearInterval(pollInterval);
          window.removeEventListener('resize', checkMobile);
        };
      }, []);

      async function loadData() {
        try {
          const tasksSnapshot = await database.ref('planner-tasks').once('value');
          const weeklySnapshot = await database.ref('planner-weekly').once('value');
          const categoriesSnapshot = await database.ref('planner-categories').once('value');
          
          const tasksData = tasksSnapshot.val();
          const weeklyDataFromDB = weeklySnapshot.val();
          const categoriesData = categoriesSnapshot.val();
          
          if (tasksData && Array.isArray(tasksData)) {
            setTasks(tasksData);
          } else {
            setTasks(INITIAL_TASKS);
            await database.ref('planner-tasks').set(INITIAL_TASKS);
          }
          
          if (weeklyDataFromDB && typeof weeklyDataFromDB === 'object') {
            setWeeklyData(weeklyDataFromDB);
          } else {
            setWeeklyData(INITIAL_WEEKLY_DATA);
            await database.ref('planner-weekly').set(INITIAL_WEEKLY_DATA);
          }
          
          if (categoriesData && Array.isArray(categoriesData)) {
            setCategories(categoriesData);
          } else {
            setCategories(DEFAULT_CATEGORIES);
            await database.ref('planner-categories').set(DEFAULT_CATEGORIES);
          }
          
          setSyncStatus('Synced ‚úì');
        } catch (error) {
          console.error('Error loading data:', error);
          setSyncStatus('Sync error');
          setTasks(INITIAL_TASKS);
          setWeeklyData(INITIAL_WEEKLY_DATA);
          setCategories(DEFAULT_CATEGORIES);
        }
        setLoading(false);
      }

      async function saveData() {
        try {
          setSyncStatus('Saving...');
          await database.ref('planner-tasks').set(tasks);
          await database.ref('planner-weekly').set(weeklyData);
          await database.ref('planner-categories').set(categories);
          setSyncStatus('Synced ‚úì');
        } catch (error) {
          console.error('Save error:', error);
          setSyncStatus('Sync error');
        }
      }

      useEffect(() => {
        if (!loading && tasks.length > 0) {
          const timeoutId = setTimeout(() => {
            saveData();
          }, 3000); // Wait 3 seconds after last change before saving
          
          return () => clearTimeout(timeoutId);
        }
      }, [tasks, weeklyData, categories, loading]);

      function getSunday(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day;
        return new Date(d.setDate(diff));
      }

      function formatTime(minutes) {
        if (minutes === 0) return '0m';
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        if (hours === 0) return `${mins}m`;
        if (mins === 0) return `${hours}h`;
        return `${hours}h ${mins}m`;
      }

      function getWeekKey(date) {
        return date.toISOString().split('T')[0];
      }

      // Helper to convert day index to Firebase-safe key (prefix with 'd' to prevent array conversion)
      function dayKey(dayIndex) {
        return `d${dayIndex}`;
      }
      
      // Helper to get urgency value using prefixed key
      function getUrgency(taskData, dayIndex) {
        if (!taskData || !taskData.urgencies) return undefined;
        // Try prefixed key first, then numeric key for backwards compatibility
        const val = taskData.urgencies[dayKey(dayIndex)];
        if (val !== undefined) return val;
        return taskData.urgencies[dayIndex];
      }
      
      // Helper to get completed value using prefixed key
      function getCompleted(taskData, dayIndex) {
        if (!taskData || !taskData.completed) return false;
        // Try prefixed key first, then numeric key for backwards compatibility
        const val = taskData.completed[dayKey(dayIndex)];
        if (val !== undefined) return val;
        return taskData.completed[dayIndex] || false;
      }

      function setUrgency(taskId, dayIndex, urgency) {
        const weekKey = getWeekKey(currentWeekStart);
        const newWeeklyData = JSON.parse(JSON.stringify(weeklyData)); // Deep copy
        
        if (!newWeeklyData[weekKey]) {
          newWeeklyData[weekKey] = {};
        }
        if (!newWeeklyData[weekKey][taskId]) {
          newWeeklyData[weekKey][taskId] = { urgencies: {}, completed: {} };
        }
        if (!newWeeklyData[weekKey][taskId].urgencies || Array.isArray(newWeeklyData[weekKey][taskId].urgencies)) {
          newWeeklyData[weekKey][taskId].urgencies = {};
        }
        
        if (urgency === '') {
          delete newWeeklyData[weekKey][taskId].urgencies[dayKey(dayIndex)];
        } else {
          newWeeklyData[weekKey][taskId].urgencies[dayKey(dayIndex)] = parseInt(urgency);
        }
        
        setWeeklyData(newWeeklyData);
      }

      function toggleComplete(taskId, dayIndex) {
        const weekKey = getWeekKey(currentWeekStart);
        const newWeeklyData = JSON.parse(JSON.stringify(weeklyData)); // Deep copy
        
        if (!newWeeklyData[weekKey]) {
          newWeeklyData[weekKey] = {};
        }
        if (!newWeeklyData[weekKey][taskId]) {
          newWeeklyData[weekKey][taskId] = { urgencies: {}, completed: {} };
        }
        if (!newWeeklyData[weekKey][taskId].completed || Array.isArray(newWeeklyData[weekKey][taskId].completed)) {
          newWeeklyData[weekKey][taskId].completed = {};
        }
        
        const currentStatus = getCompleted(newWeeklyData[weekKey][taskId], dayIndex);
        newWeeklyData[weekKey][taskId].completed[dayKey(dayIndex)] = !currentStatus;
        
        setWeeklyData(newWeeklyData);
      }

      function getTaskData(taskId) {
        const weekKey = getWeekKey(currentWeekStart);
        const data = weeklyData[weekKey]?.[taskId];
        
        // Return safe default if data doesn't exist
        if (!data) return { urgencies: {}, completed: {} };
        
        // Ensure urgencies and completed are objects, not arrays or undefined
        return {
          urgencies: data.urgencies || {},
          completed: data.completed || {}
        };
      }

      function calculateDayTotals(dayIndex) {
        const totals = { 
          total: 0, 
          completed: 0,
          byUrgency: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 } 
        };
        
        if (!tasks || !Array.isArray(tasks)) return totals;
        
        tasks.forEach(task => {
          if (!task || !task.id) return;
          
          const taskData = getTaskData(task.id);
          if (!taskData) return;
          
          const urgency = getUrgency(taskData, dayIndex);
          
          if (urgency !== undefined && urgency !== null) {
            totals.total += (task.minutes || 0);
            totals.byUrgency[urgency] = (totals.byUrgency[urgency] || 0) + (task.minutes || 0);
            
            if (getCompleted(taskData, dayIndex)) {
              totals.completed += (task.minutes || 0);
            }
          }
        });
        
        return totals;
      }

      function sortTasks(key, dayIndex = null) {
        let direction = 'asc';
        if (sortConfig.key === key && sortConfig.dayIndex === dayIndex && sortConfig.direction === 'asc') {
          direction = 'desc';
        }
        
        setSortConfig({ key, direction, dayIndex });
      }

      function getSortedTasks() {
        if (!sortConfig.key) return tasks;
        
        const sorted = [...tasks].sort((a, b) => {
          let aVal, bVal;
          
          if (sortConfig.key === 'day') {
            const aData = getTaskData(a.id);
            const bData = getTaskData(b.id);
            aVal = getUrgency(aData, sortConfig.dayIndex) || 999;
            bVal = getUrgency(bData, sortConfig.dayIndex) || 999;
          } else if (sortConfig.key === 'name') {
            aVal = a.name.toLowerCase();
            bVal = b.name.toLowerCase();
          } else if (sortConfig.key === 'category') {
            aVal = a.category;
            bVal = b.category;
          } else if (sortConfig.key === 'importance') {
            aVal = a.importance;
            bVal = b.importance;
          } else if (sortConfig.key === 'minutes') {
            aVal = a.minutes;
            bVal = b.minutes;
          }
          
          if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
          if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
          return 0;
        });
        
        return sorted;
      }

      function calculateWeekTotals() {
        const totals = { total: 0, completed: 0, byUrgency: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 } };
        
        DAYS.forEach((_, dayIndex) => {
          const dayTotals = calculateDayTotals(dayIndex);
          totals.total += dayTotals.total;
          totals.completed += dayTotals.completed;
          Object.keys(dayTotals.byUrgency).forEach(urgency => {
            totals.byUrgency[urgency] += dayTotals.byUrgency[urgency];
          });
        });
        
        return totals;
      }

      function addTask(newTask) {
        const task = {
          ...newTask,
          id: Date.now()
        };
        setTasks([...tasks, task]);
      }

      function updateTask(updatedTask) {
        setTasks(tasks.map(t => t.id === updatedTask.id ? updatedTask : t));
      }

      function deleteTask(taskId) {
        setTasks(tasks.filter(t => t.id !== taskId));
      }

      function navigateWeek(direction) {
        const newDate = new Date(currentWeekStart);
        newDate.setDate(newDate.getDate() + (direction * 7));
        setCurrentWeekStart(getSunday(newDate));
      }

      function importPreviousWeek() {
        const prevWeekStart = new Date(currentWeekStart);
        prevWeekStart.setDate(prevWeekStart.getDate() - 7);
        const prevWeekKey = getWeekKey(prevWeekStart);
        const currentWeekKey = getWeekKey(currentWeekStart);
        
        if (!weeklyData[prevWeekKey]) {
          alert('No data found for previous week to import');
          return;
        }
        
        const newWeeklyData = JSON.parse(JSON.stringify(weeklyData));
        
        if (!newWeeklyData[currentWeekKey]) {
          newWeeklyData[currentWeekKey] = {};
        }
        
        Object.keys(weeklyData[prevWeekKey]).forEach(taskId => {
          const prevTaskData = weeklyData[prevWeekKey][taskId];
          // Import urgencies but not completions
          newWeeklyData[currentWeekKey][taskId] = {
            urgencies: { ...(prevTaskData.urgencies || {}) },
            completed: {}
          };
        });
        
        setWeeklyData(newWeeklyData);
      }

      if (loading) {
        return <div className="flex items-center justify-center h-screen text-white">Loading...</div>;
      }

      const weekTotals = calculateWeekTotals();
      const sortedTasks = getSortedTasks();
      
      const SortIcon = ({ columnKey, dayIndex = null }) => {
        const isActive = sortConfig.key === columnKey && 
                         (dayIndex === null || sortConfig.dayIndex === dayIndex);
        if (!isActive) return <span className="text-gray-400 ml-1">‚Üï</span>;
        return <span className="ml-1">{sortConfig.direction === 'asc' ? '‚Üë' : '‚Üì'}</span>;
      };

      // Mobile View
      if (isMobile) {
        const dayTotals = calculateDayTotals(selectedDay);
        const currentDate = new Date(currentWeekStart);
        currentDate.setDate(currentDate.getDate() + selectedDay);
        
        return (
          <div className="min-h-screen bg-gray-700 p-2">
            <div className="max-w-2xl mx-auto">
              <div className="bg-gray-800 rounded-lg shadow-lg p-4 mb-2 text-white">
                <div className="flex justify-between items-center mb-3">
                  <h1 className="text-xl font-bold">Weekly Planner</h1>
                  <span className="text-xs text-gray-400">{syncStatus}</span>
                </div>
                
                <div className="flex justify-between items-center mb-3">
                  <button
                    onClick={() => navigateWeek(-1)}
                    className="px-3 py-1 bg-gray-200 text-gray-900 rounded text-sm"
                  >
                    ‚Üê Prev
                  </button>
                  <button
                    onClick={importPreviousWeek}
                    className="px-2 py-1 bg-green-600 text-white text-xs rounded"
                  >
                    Import
                  </button>
                  <button
                    onClick={() => navigateWeek(1)}
                    className="px-3 py-1 bg-gray-200 text-gray-900 rounded text-sm"
                  >
                    Next ‚Üí
                  </button>
                </div>
                
                <div className="mb-3">
                  <select
                    value={selectedDay}
                    onChange={(e) => setSelectedDay(parseInt(e.target.value))}
                    className="w-full px-3 py-2 bg-gray-700 border border-gray-500 rounded text-white text-lg"
                  >
                    {DAYS.map((day, index) => {
                      const date = new Date(currentWeekStart);
                      date.setDate(date.getDate() + index);
                      return (
                        <option key={index} value={index}>
                          {day} - {date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                        </option>
                      );
                    })}
                  </select>
                </div>
                
                <div className="bg-gray-700 p-3 rounded-lg mb-3">
                  <div className="grid grid-cols-3 gap-2 text-center text-sm mb-2">
                    <div>
                      <div className="text-gray-300">Planned</div>
                      <div className="font-bold">{formatTime(dayTotals.total)}</div>
                    </div>
                    <div>
                      <div className="text-gray-300">Done</div>
                      <div className="font-bold text-green-400">{formatTime(dayTotals.completed)}</div>
                    </div>
                    <div>
                      <div className="text-gray-300">Left</div>
                      <div className="font-bold text-orange-400">{formatTime(dayTotals.total - dayTotals.completed)}</div>
                    </div>
                  </div>
                  <div className="w-full bg-gray-600 rounded-full h-3">
                    <div 
                      className="bg-green-500 h-3 rounded-full transition-all" 
                      style={{ width: `${dayTotals.total > 0 ? Math.round((dayTotals.completed / dayTotals.total) * 100) : 0}%` }}
                    ></div>
                  </div>
                </div>
                
                <button
                  onClick={() => setShowTaskManager(!showTaskManager)}
                  className="w-full mb-3 px-4 py-2 bg-blue-600 text-white rounded-lg"
                >
                  {showTaskManager ? 'Close' : 'Manage Tasks'}
                </button>
                
                {showTaskManager && (
                  <TaskManager
                    tasks={tasks}
                    categories={categories}
                    onAddTask={addTask}
                    onUpdateTask={updateTask}
                    onDeleteTask={deleteTask}
                    onUpdateCategories={setCategories}
                    onClose={() => setShowTaskManager(false)}
                  />
                )}
                
                {!showTaskManager && (
                  <div className="space-y-2">
                    {sortedTasks
                      .filter(task => getUrgency(getTaskData(task.id), selectedDay) !== undefined)
                      .sort((a, b) => {
                        const aUrgency = getUrgency(getTaskData(a.id), selectedDay) || 999;
                        const bUrgency = getUrgency(getTaskData(b.id), selectedDay) || 999;
                        return aUrgency - bUrgency;
                      })
                      .map(task => {
                        const taskData = getTaskData(task.id);
                        const urgency = getUrgency(taskData, selectedDay);
                        const isCompleted = getCompleted(taskData, selectedDay);
                        const categoryColor = categories.find(c => c.name === task.category)?.color || '';
                        
                        return (
                          <div key={task.id} className={`${categoryColor} p-3 rounded-lg border-2`}>
                            <div className="flex items-start justify-between">
                              <div className="flex items-start gap-2 flex-1">
                                <input
                                  type="checkbox"
                                  checked={isCompleted || false}
                                  onChange={() => toggleComplete(task.id, selectedDay)}
                                  className="w-5 h-5 mt-1"
                                />
                                <div className="flex-1">
                                  <div className={`font-semibold ${isCompleted ? 'line-through opacity-60' : ''}`}>
                                    {task.name}
                                  </div>
                                  <div className="text-xs mt-1 opacity-80">
                                    {task.category} ‚Ä¢ {task.importance} ‚Ä¢ {task.minutes}m ‚Ä¢ U{urgency}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    {sortedTasks.filter(task => getUrgency(getTaskData(task.id), selectedDay) !== undefined).length === 0 && (
                      <div className="text-center text-gray-400 py-8">
                        No tasks assigned for this day
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      // Desktop View
      return (
        <div className="min-h-screen bg-gray-700 p-4">
          <div className="max-w-7xl mx-auto">
            <div className="bg-gray-800 rounded-lg shadow-lg p-6 mb-4 text-white">
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-3xl font-bold text-white">Weekly Task Planner</h1>
                <div className="flex items-center gap-4">
                  <span className="text-sm text-gray-400">{syncStatus}</span>
                  <button
                    onClick={() => setShowTaskManager(!showTaskManager)}
                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    ‚öôÔ∏è Manage Tasks
                  </button>
                </div>
              </div>

              <div className="flex justify-between items-center mb-6">
                <button
                  onClick={() => navigateWeek(-1)}
                  className="px-4 py-2 bg-gray-200 text-gray-900 rounded-lg hover:bg-gray-300"
                >
                  ‚Üê Previous Week
                </button>
                <div className="flex flex-col items-center gap-2">
                  <h2 className="text-xl font-semibold">
                    Week of {currentWeekStart.toLocaleDateString()}
                  </h2>
                  <button
                    onClick={importPreviousWeek}
                    className="px-3 py-1 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700"
                  >
                    üì• Import Previous Week
                  </button>
                </div>
                <button
                  onClick={() => navigateWeek(1)}
                  className="px-4 py-2 bg-gray-200 text-gray-900 rounded-lg hover:bg-gray-300"
                >
                  Next Week ‚Üí
                </button>
              </div>

              {showTaskManager && (
                <TaskManager
                  tasks={tasks}
                  categories={categories}
                  onAddTask={addTask}
                  onUpdateTask={updateTask}
                  onDeleteTask={deleteTask}
                  onUpdateCategories={setCategories}
                  onClose={() => setShowTaskManager(false)}
                />
              )}

              <div className="mb-6 bg-gradient-to-r from-gray-600 to-gray-700 p-4 rounded-lg border-2 border-gray-500">
                <h3 className="text-lg font-bold mb-3 text-center text-white">Daily Summary</h3>
                <div className="grid grid-cols-7 gap-2">
                  {DAYS.map((day, dayIndex) => {
                    const totals = calculateDayTotals(dayIndex);
                    const completionRate = totals.total > 0 ? Math.round((totals.completed / totals.total) * 100) : 0;
                    return (
                      <div key={day} className="bg-gray-700 p-3 rounded-lg shadow-sm border border-gray-500 text-white">
                        <h4 className="font-bold text-center mb-2 text-sm">{day}</h4>
                        <div className="space-y-1 text-xs">
                          <div className="flex justify-between">
                            <span className="text-gray-300">Planned:</span>
                            <span className="font-semibold">{formatTime(totals.total)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-300">Done:</span>
                            <span className="font-semibold text-green-400">{formatTime(totals.completed)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-300">Left:</span>
                            <span className="font-semibold text-orange-400">{formatTime(totals.total - totals.completed)}</span>
                          </div>
                          <div className="mt-2 pt-2 border-t border-gray-500">
                            <div className="w-full bg-gray-600 rounded-full h-2">
                              <div 
                                className="bg-green-500 h-2 rounded-full transition-all" 
                                style={{ width: `${completionRate}%` }}
                              ></div>
                            </div>
                            <p className="text-center mt-1 font-semibold">{completionRate}%</p>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              <div className="overflow-x-auto max-h-[600px] overflow-y-auto">
                <table className="w-full border-collapse">
                  <thead>
                    <tr>
                      <th 
                        className="border border-gray-600 p-2 bg-gray-700 sticky-corner cursor-pointer hover:bg-gray-600"
                        onClick={() => sortTasks('name')}
                      >
                        Task <SortIcon columnKey="name" />
                      </th>
                      <th 
                        className="border border-gray-600 p-2 bg-gray-700 sticky-header cursor-pointer hover:bg-gray-600"
                        onClick={() => sortTasks('category')}
                      >
                        Cat <SortIcon columnKey="category" />
                      </th>
                      <th 
                        className="border border-gray-600 p-2 bg-gray-700 sticky-header cursor-pointer hover:bg-gray-600"
                        onClick={() => sortTasks('importance')}
                      >
                        Imp <SortIcon columnKey="importance" />
                      </th>
                      <th 
                        className="border border-gray-600 p-2 bg-gray-700 sticky-header cursor-pointer hover:bg-gray-600"
                        onClick={() => sortTasks('minutes')}
                      >
                        Min <SortIcon columnKey="minutes" />
                      </th>
                      {DAYS.map((day, dayIndex) => (
                        <th 
                          key={day} 
                          className="border border-gray-600 p-2 bg-gray-700 sticky-header cursor-pointer hover:bg-gray-600"
                          onClick={() => sortTasks('day', dayIndex)}
                        >
                          {day} <SortIcon columnKey="day" dayIndex={dayIndex} />
                        </th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {sortedTasks.map(task => {
                      const taskData = getTaskData(task.id);
                      const categoryColor = categories.find(c => c.name === task.category)?.color || '';
                      
                      return (
                        <tr key={task.id} className={`${categoryColor} border-2 text-sm`}>
                          <td className="border border-gray-600 p-1 font-medium sticky-col bg-inherit">
                            {task.name}
                          </td>
                          <td className="border border-gray-600 p-1 text-center text-xs">{task.category}</td>
                          <td className="border border-gray-600 p-1 text-center font-bold">{task.importance}</td>
                          <td className="border border-gray-600 p-1 text-center">{task.minutes}</td>
                          {DAYS.map((_, dayIndex) => (
                            <td key={dayIndex} className="border border-gray-600 p-1">
                              <div className="flex items-center gap-1">
                                <input
                                  type="text"
                                  value={getUrgency(taskData, dayIndex) || ''}
                                  onChange={(e) => setUrgency(task.id, dayIndex, e.target.value)}
                                  className="w-7 text-center border rounded text-sm"
                                  maxLength="1"
                                  placeholder="-"
                                />
                                <input
                                  type="checkbox"
                                  checked={getCompleted(taskData, dayIndex)}
                                  onChange={() => toggleComplete(task.id, dayIndex)}
                                  className="w-4 h-4"
                                  disabled={!getUrgency(taskData, dayIndex)}
                                />
                              </div>
                            </td>
                          ))}
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>

              <div className="mt-6 grid grid-cols-8 gap-4">
                {DAYS.map((day, dayIndex) => {
                  const totals = calculateDayTotals(dayIndex);
                  return (
                    <div key={day} className="bg-gray-700 p-3 rounded-lg text-white">
                      <h3 className="font-bold text-center mb-2">{day}</h3>
                      <p className="text-center text-lg font-bold">{formatTime(totals.total)}</p>
                      <p className="text-center text-sm text-green-400">‚úì {formatTime(totals.completed)}</p>
                      <div className="text-xs mt-2 space-y-1">
                        {[1, 2, 3, 4, 5].map(urgency => (
                          totals.byUrgency[urgency] > 0 && (
                            <p key={urgency}>U{urgency}: {formatTime(totals.byUrgency[urgency])}</p>
                          )
                        ))}
                      </div>
                    </div>
                  );
                })}
                <div className="bg-blue-700 p-3 rounded-lg text-white">
                  <h3 className="font-bold text-center mb-2">Week</h3>
                  <p className="text-center text-lg font-bold">{formatTime(weekTotals.total)}</p>
                  <p className="text-center text-sm text-green-400">‚úì {formatTime(weekTotals.completed)}</p>
                  <div className="text-xs mt-2 space-y-1">
                    {[1, 2, 3, 4, 5].map(urgency => (
                      weekTotals.byUrgency[urgency] > 0 && (
                        <p key={urgency}>U{urgency}: {formatTime(weekTotals.byUrgency[urgency])}</p>
                      )
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function TaskManager({ tasks, categories, onAddTask, onUpdateTask, onDeleteTask, onUpdateCategories, onClose }) {
      const [newTask, setNewTask] = useState({
        name: '',
        category: categories[0]?.name || 'Work',
        importance: 'B',
        minutes: 30
      });
      const [showCategoryEditor, setShowCategoryEditor] = useState(false);
      const [editingCategories, setEditingCategories] = useState([...categories]);
      const [sortBy, setSortBy] = useState('name');
      const [sortDirection, setSortDirection] = useState('asc');
      const [editingTaskId, setEditingTaskId] = useState(null);
      const [editingTask, setEditingTask] = useState(null);

      function handleSubmit(e) {
        e.preventDefault();
        if (newTask.name.trim()) {
          onAddTask(newTask);
          setNewTask({ name: '', category: categories[0]?.name || 'Work', importance: 'B', minutes: 30 });
        }
      }
      
      function updateCategoryName(index, newName) {
        const updated = [...editingCategories];
        updated[index] = { ...updated[index], name: newName };
        setEditingCategories(updated);
      }
      
      function saveCategoryChanges() {
        onUpdateCategories(editingCategories);
        setShowCategoryEditor(false);
      }
      
      function cancelCategoryChanges() {
        setEditingCategories([...categories]);
        setShowCategoryEditor(false);
      }
      
      function handleSort(column) {
        if (sortBy === column) {
          setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
        } else {
          setSortBy(column);
          setSortDirection('asc');
        }
      }
      
      function getSortedTasks() {
        const sorted = [...tasks].sort((a, b) => {
          let aVal, bVal;
          
          if (sortBy === 'name') {
            aVal = a.name.toLowerCase();
            bVal = b.name.toLowerCase();
          } else if (sortBy === 'category') {
            aVal = a.category;
            bVal = b.category;
          } else if (sortBy === 'importance') {
            aVal = a.importance;
            bVal = b.importance;
          } else if (sortBy === 'minutes') {
            aVal = a.minutes;
            bVal = b.minutes;
          }
          
          if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
          if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
          return 0;
        });
        
        return sorted;
      }
      
      function startEditing(task) {
        setEditingTaskId(task.id);
        setEditingTask({ ...task });
      }
      
      function cancelEditing() {
        setEditingTaskId(null);
        setEditingTask(null);
      }
      
      function saveEdit() {
        if (editingTask && editingTask.name.trim()) {
          onUpdateTask(editingTask);
        }
        setEditingTaskId(null);
        setEditingTask(null);
      }
      
      const SortIndicator = ({ column }) => {
        if (sortBy !== column) return <span className="text-gray-400 ml-1">‚Üï</span>;
        return <span className="ml-1">{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}</span>;
      };

      const sortedTasks = getSortedTasks();

      return (
        <div className="mb-6 p-4 bg-gray-700 rounded-lg border-2 border-blue-400 text-white">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold">Task Manager</h3>
            <div className="flex gap-2">
              <button 
                onClick={() => setShowCategoryEditor(!showCategoryEditor)}
                className="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm"
              >
                ‚úèÔ∏è Edit Categories
              </button>
              <button onClick={onClose} className="text-gray-300 hover:text-white text-2xl">‚úï</button>
            </div>
          </div>

          {showCategoryEditor && (
            <div className="mb-4 p-3 bg-gray-800 rounded-lg border-2 border-indigo-400">
              <h4 className="font-bold mb-2 text-white">Edit Category Names</h4>
              <div className="grid grid-cols-2 gap-2 mb-3">
                {editingCategories.map((cat, index) => (
                  <div key={index} className={`flex items-center gap-2 p-2 rounded ${cat.color}`}>
                    <input
                      type="text"
                      value={cat.name}
                      onChange={(e) => updateCategoryName(index, e.target.value)}
                      className="flex-1 px-2 py-1 border rounded text-sm text-gray-900"
                    />
                  </div>
                ))}
              </div>
              <div className="flex gap-2 justify-end">
                <button 
                  onClick={cancelCategoryChanges}
                  className="px-3 py-1 bg-gray-300 text-gray-900 rounded hover:bg-gray-400"
                >
                  Cancel
                </button>
                <button 
                  onClick={saveCategoryChanges}
                  className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700"
                >
                  Save Changes
                </button>
              </div>
            </div>
          )}

          <form onSubmit={handleSubmit} className="mb-4 grid grid-cols-5 gap-2">
            <input
              type="text"
              placeholder="Task name"
              value={newTask.name}
              onChange={(e) => setNewTask({ ...newTask, name: e.target.value })}
              className="col-span-2 px-3 py-2 border rounded text-gray-900"
            />
            <select
              value={newTask.category}
              onChange={(e) => setNewTask({ ...newTask, category: e.target.value })}
              className="px-3 py-2 border rounded text-gray-900"
            >
              {categories.map(cat => (
                <option key={cat.name} value={cat.name}>{cat.name}</option>
              ))}
            </select>
            <select
              value={newTask.importance}
              onChange={(e) => setNewTask({ ...newTask, importance: e.target.value })}
              className="px-3 py-2 border rounded text-gray-900"
            >
              {IMPORTANCE_LEVELS.map(imp => (
                <option key={imp} value={imp}>{imp}</option>
              ))}
            </select>
            <div className="flex gap-2">
              <input
                type="number"
                placeholder="Minutes"
                value={newTask.minutes}
                onChange={(e) => setNewTask({ ...newTask, minutes: parseInt(e.target.value) })}
                className="w-20 px-3 py-2 border rounded text-gray-900"
              />
              <button type="submit" className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                ‚ûï
              </button>
            </div>
          </form>

          <div className="max-h-96 overflow-y-auto">
            <table className="w-full text-sm">
              <thead className="sticky top-0 bg-gray-600 z-10">
                <tr>
                  <th 
                    className="p-2 text-left cursor-pointer hover:bg-gray-500"
                    onClick={() => handleSort('name')}
                  >
                    Task <SortIndicator column="name" />
                  </th>
                  <th 
                    className="p-2 cursor-pointer hover:bg-gray-500"
                    onClick={() => handleSort('category')}
                  >
                    Category <SortIndicator column="category" />
                  </th>
                  <th 
                    className="p-2 cursor-pointer hover:bg-gray-500"
                    onClick={() => handleSort('importance')}
                  >
                    Importance <SortIndicator column="importance" />
                  </th>
                  <th 
                    className="p-2 cursor-pointer hover:bg-gray-500"
                    onClick={() => handleSort('minutes')}
                  >
                    Minutes <SortIndicator column="minutes" />
                  </th>
                  <th className="p-2">Actions</th>
                </tr>
              </thead>
              <tbody>
                {sortedTasks.map(task => (
                  <tr key={task.id} className="border-b border-gray-600">
                    {editingTaskId === task.id ? (
                      <>
                        <td className="p-2">
                          <input
                            type="text"
                            value={editingTask.name}
                            onChange={(e) => setEditingTask({ ...editingTask, name: e.target.value })}
                            className="w-full px-2 py-1 border rounded text-gray-900 text-sm"
                          />
                        </td>
                        <td className="p-2">
                          <select
                            value={editingTask.category}
                            onChange={(e) => setEditingTask({ ...editingTask, category: e.target.value })}
                            className="w-full px-2 py-1 border rounded text-gray-900 text-sm"
                          >
                            {categories.map(cat => (
                              <option key={cat.name} value={cat.name}>{cat.name}</option>
                            ))}
                          </select>
                        </td>
                        <td className="p-2">
                          <select
                            value={editingTask.importance}
                            onChange={(e) => setEditingTask({ ...editingTask, importance: e.target.value })}
                            className="w-full px-2 py-1 border rounded text-gray-900 text-sm"
                          >
                            {IMPORTANCE_LEVELS.map(imp => (
                              <option key={imp} value={imp}>{imp}</option>
                            ))}
                          </select>
                        </td>
                        <td className="p-2">
                          <input
                            type="number"
                            value={editingTask.minutes}
                            onChange={(e) => setEditingTask({ ...editingTask, minutes: parseInt(e.target.value) })}
                            className="w-full px-2 py-1 border rounded text-gray-900 text-sm"
                          />
                        </td>
                        <td className="p-2">
                          <div className="flex gap-1">
                            <button
                              onClick={saveEdit}
                              className="text-green-400 hover:text-green-300 text-xs"
                            >
                              Save
                            </button>
                            <button
                              onClick={cancelEditing}
                              className="text-red-400 hover:text-red-300 text-xs"
                            >
                              Cancel
                            </button>
                          </div>
                        </td>
                      </>
                    ) : (
                      <>
                        <td className="p-2">{task.name}</td>
                        <td className="p-2 text-center">{task.category}</td>
                        <td className="p-2 text-center">{task.importance}</td>
                        <td className="p-2 text-center">{task.minutes}</td>
                        <td className="p-2 text-center">
                          <div className="flex gap-1 justify-center">
                            <button
                              onClick={() => startEditing(task)}
                              className="text-blue-400 hover:text-blue-300 text-xs"
                            >
                              Edit
                            </button>
                            <button
                              onClick={() => onDeleteTask(task.id)}
                              className="text-red-400 hover:text-red-300 text-xs"
                            >
                              Delete
                            </button>
                          </div>
                        </td>
                      </>
                    )}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    function App() {
      return <WeeklyPlanner />;
    }
    
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
